# imarket

### _Backend_ приложене интернет-магазина на NodeJS

## Структура проекта
+ config
  + databaseConfig.js
  + jwtSecret.js
+ controllers
  + adminController.js
  + authorizationController.js
  + customerController.js
+ middleware
  + adminMiddleware.js
  + authMiddleware.js
+ models
  + User.js
+ routers
  + adminRouter.js
  + authRouter.js
  + customerRouter.js
+ util
  + Database.js
+ index.js
+ package-lock.json
+ package.json
+ README.md

## Перед тем как запускать

Перед запуском в директории с проектом необходимо выполнить команду
```bash
$ npm i
```

Это установит зависимости для __imarket__

Более того необходимо установить дамп БД на сервере. Дамп содержится в файле `imarket.sql`. Для установки необходимо:
### Windows
1. Перейти в директорию, куда был установлен PostgreSQL. По умолчанию это `C:\Program Files\PostgreSQL\версия\bin`
2. Выполнить следующий скрипт:
   ```bash
   $ psql -U имя_пользователя -d имя_базы_данных -f путь_к_файлу.sql
   ```
   Где:
   + имя_пользователя - имя пользователя, имеющего права доступа к базе данных
   + имя_базы_данных - имя базы данных, на которую вы хотите применить дамп
   + путь_к_файлу.sql - путь к файлу `imarket.sql`
3. После этого потребуется ввести пароль администратора, и дамп будет успешно установлен

## Использование приложения

```bash
$ npm run prod
```

Это запустит сервер и позволит ему принимать и обрабатывать запросы

## Сущности и их поля

+ `User`
  + `first_name` - основное имя
  + `last_name` - фамилия
  + `mid_name` - отчество
  + `email*` - адрес электронной почты (уникальный для каждого)
  + `password_hash*` - хэш пароля
  + `role*` - роль пользователя: `Покупатель`, либо `Администратор` (по умолчанию первое)

## Возможные запросы

Ниже приведён список запросов для взаимодействия с __imarket__

### Для неавторизованного пользователя

+ `POST /auth/register` - регистрация (создание) пользователя.
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `email*` - адрес электронной почты
    + `password*` - пароль пользователя
    + `firstName` - имя пользователя
    + `lastName` - фамилия пользователя
    + `midName` - отчество пользователя
  + Данные ответа
    + `message` - краткий ответ
    + `user` - сущность созданного пользователя

+ `POST /auth/login` - авторизация
  + Передача данных запроса по `POST body`
  + Данные запроса
    + `email*` - адрес электронной почты
    + `password*` - пароль пользователя
  + Данные ответа
    + `message` - краткий ответ
    + `token` - __JWT__ токен для __Bearer__ авторизации

### Для покупателя (и администратора как частного его вида)

Для авторизованного покупателя токен для авторизации передается в __HTTP__ заголовке `Authorization` в формате `Bearer токен`

+ `GET /users/self` - получение данных о себе
  + Данные ответа
    + `message` - краткий ответ
    + `user` - сущность текущего авторизованного пользователя

### Для администратора

Для администратора токен для авторизации передается аналогично предыдущему случаю

+ `GET /roles` - получение данных о всех ролях для пользователей
  + Данные ответа
    + `message` - краткий ответ
    + `roles` - список ролей с их идентификаторами `id` и названиями `name`

+ `GET /users` - получение данных о всех пользователях
  + Передача данных запроса по `query string`
  + Данные запроса
    + `limit` - максимальное количество полученных сущностей типа `User`
  + Данные ответа
    + `message` - краткий ответ
    + `users` - список сущностей всех пользователей, ограниченных количеством `limit`

+ `GET /users/:id` - получение данных о об одном пользователе с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ
    + `user` - сущность найденного пользователя

+ `PATCH /users/:id` - изменение роли одного пользователя с идентификатором `:id`
  + Передача данных запроса по `PATCH body`
  + Данные запроса
    + `roleId*` - идентификатор роли, которую нужно присвоить выбранному пользователю
  + Данные ответа
    + `message` - краткий ответ
    + `user` - изменённая сущность пользователя

+ `PUT /users/:id` - изменение всех данных кроме роли одного пользователя с идентификатором `:id`
  + Передача данных запроса по `PUT body`
  + Данные запроса
    + `firstName` - новое имя пользователя
    + `lastName` - новая фамилия пользователя
    + `midName` - новое отчество пользователя
    + `email` - новый адрес электронной почты
    + `password` - новый пароль пользователя
  + Данные ответа
    + `message` - краткий ответ
    + `user` - изменённая сущность пользователя

+ `DELETE /users/:id` - удаление пользователя с идентификатором `:id`
  + Данные ответа
    + `message` - краткий ответ
    + `user` - удалённая сущность пользователя

## Используемые технологии
+ [NodeJS](https://nodejs.org/en)
  + [express](https://www.npmjs.com/package/express) - библиотека для создания __HTTP__ сервера
  + [bcrypt](https://www.npmjs.com/package/bcrypt) - библиотека шифрования паролей
  + [jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken) - библиотека для работы с __JWT__ токенами
  + [pg](https://www.npmjs.com/package/pg) - библиотека для отправки запросов к БД __PostgreSQL__
  + [nodemon](https://www.npmjs.com/package/nodemon) - библиотека для автоматического перезапуска сервера (используется при разработке)
+ [PostgreSQL](https://www.postgresql.org/) - реляционная СУБД
+ [JSON](https://ru.wikipedia.org/wiki/JSON) - формат передачи данных

## Директория `config`

+ ### `config/databaseConfig.js`
Содержит данные для корректного подключения к базе данных PostgreSQL
+ ### `config/jwtSecret.js`
Содержит в поле `secret` значение секретного ключа для формирования __JWT__ токена

## __MVC__ в __imarket__
__imarket__ реализует паттерн __MVC__, однако передача данных клиенту осуществляется в формате __JSON__, поэтому __imarket__ не имеет _представлений_ как таковых. Доказательством разработки по паттерну __MVC__ служат директории `controllers`, `models`

## Директория `controllers`

Содержит контроллеры (__MVC__)

+ ### `controllers/authorizationController.js`
Представляет контроллер для обработки запросов неавторизованных пользователей
+ ### `controllers/customerController.js`
Представляет контроллер для обработки запросов покупателей (в том числе и администраторов)
+ ### `controllers/adminController.js`
Представляет контроллер для обработки запросов администраторов

## Директория `models`

Содержит модели (__MVC__)

+ ### `models/User.js`
Представляет модель с методами для получения, изменения и удаления, связанных с сущностью `User`

## Директория `routers`

Содержит роутеры с роутами для отдельных случаев авторизации

+ ### `router/authRouter.js`
Представляет роуты для неавторизованного пользователя
+ ### `routers/customerRouter.js`
Представляет роуты для авторизованного покупателя (в том числе и администраторов)
+ ### `routers/adminRouter.js`
Представляет роуты для администратора

## Директория `middleware`

Содержит ПО промежуточного уровня для отслеживания роли текущего авторизированного (или нет) пользователя

+ ### `middleware/authMiddleware.js`
Осуществляет проверку запроса на авторизацию
+ ### `routers/adminMiddleware.js`
Осуществляет проверку роли авторизованного пользователя на соответствие роли `Администратор`

## Незаконченный функционал

В скором времени планируется добавить обработку запросов связанных с:

+ Товарами
+ Корзиной покупателя
+ Заказами